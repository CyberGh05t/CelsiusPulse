# Тесты для CelsiusPulse Bot

Этот каталог содержит comprehensive набор тестов для Telegram бота мониторинга температуры.

## Структура тестов

### Файлы тестов

- **`conftest.py`** - Fixtures и настройки pytest
- **`test_bot_commands.py`** - Тесты команд бота (/start, интерфейсы)
- **`test_auth.py`** - Тесты системы авторизации и ролей
- **`test_monitoring.py`** - Тесты мониторинга температуры
- **`test_notifications.py`** - Тесты системы уведомлений
- **`test_integration.py`** - Интеграционные тесты
- **`README.md`** - Этот файл

### Типы тестов

1. **Unit тесты** - Тестируют отдельные функции
2. **Integration тесты** - Тестируют взаимодействие компонентов
3. **Async тесты** - Тестируют асинхронный код
4. **Parametrized тесты** - Тестируют с различными параметрами

## Запуск тестов

### Все тесты
```bash
pytest
```

### Конкретный файл
```bash
pytest tests/test_bot_commands.py
```

### Конкретный тест
```bash
pytest tests/test_bot_commands.py::TestBotCommands::test_start_command_new_user
```

### С покрытием кода
```bash
pytest --cov=main --cov-report=html
```

### Только быстрые тесты (исключая медленные)
```bash
pytest -m "not slow"
```

### Только интеграционные тесты
```bash
pytest -m integration
```

## Markers

- `@pytest.mark.asyncio` - Асинхронные тесты
- `@pytest.mark.slow` - Медленные тесты
- `@pytest.mark.integration` - Интеграционные тесты
- `@pytest.mark.unit` - Unit тесты

## Fixtures

### Основные fixtures

- **`mock_env`** - Mock переменных окружения
- **`sample_user/chat/message/update`** - Тестовые Telegram объекты
- **`mock_context`** - Mock контекста бота
- **`temp_files`** - Временные файлы для тестов
- **`sample_sensor_data/thresholds`** - Тестовые данные датчиков

### Mock объекты

- **`mock_requests_get`** - Mock для HTTP запросов
- **`event_loop`** - Event loop для async тестов

## Тестируемая функциональность

### Команды бота
- ✅ Команда /start
- ✅ Показ интерфейсов по ролям
- ✅ Выбор групп и данных
- ✅ Административные команды

### Авторизация
- ✅ Загрузка групп пользователей
- ✅ Определение ролей (user/admin/big_boss)
- ✅ Сохранение информации администраторов
- ✅ Обновление .env файла

### Мониторинг
- ✅ Получение данных с датчиков
- ✅ Обработка ошибок API
- ✅ Загрузка/сохранение пороговых значений
- ✅ Форматирование данных

### Уведомления
- ✅ Отправка алертов
- ✅ Cooldown механизм
- ✅ Фильтрация по группам пользователей
- ✅ Retry при ошибках Telegram
- ✅ Форматирование сообщений

### Интеграционные сценарии
- ✅ Полный цикл мониторинга
- ✅ Пользовательские workflow
- ✅ Админский workflow
- ✅ Обработка ошибок
- ✅ Одновременные запросы
- ✅ Сохранение данных

## Конфигурация

### pytest.ini
Настройки pytest находятся в корне проекта:
- Автоматический режим async
- Маркеры для категоризации тестов
- Фильтрация предупреждений
- Краткий формат traceback

## Рекомендации

### При написании новых тестов:

1. **Используйте существующие fixtures** - избегайте дублирования
2. **Группируйте тесты в классы** - по функциональности
3. **Используйте descriptive имена** - тест должен объяснять что проверяет
4. **Добавляйте docstrings** - объясняйте сложные тесты
5. **Используйте parametrize** - для тестирования разных входных данных
6. **Mock внешние зависимости** - API, файлы, время
7. **Проверяйте edge cases** - пустые данные, ошибки, граничные значения

### Примеры:

```python
# Хорошо
@pytest.mark.asyncio
async def test_start_command_new_user(self, sample_update, mock_context, mock_env):
    \"\"\"Тест команды /start для нового пользователя\"\"\"
    # тест

# Плохо
async def test_start(self, update, context):
    # тест без пояснений
```

## Coverage

Цель: минимум 80% покрытия кода.

Исключения из coverage:
- Точка входа main()
- Блоки except для критических ошибок
- Код для продакшн деплоя

## Troubleshooting

### Частые проблемы:

1. **Ошибки импорта** - Проверьте PYTHONPATH
2. **Async тесты не работают** - Добавьте `@pytest.mark.asyncio`
3. **Mock не применяется** - Проверьте порядок patch'ей
4. **Fixtures не найдены** - Проверьте conftest.py

### Debugging:

```bash
# Подробный вывод
pytest -vvv

# Остановка на первой ошибке
pytest -x

# Показать print statements
pytest -s
```